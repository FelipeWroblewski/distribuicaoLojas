<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>Distribuição de Produtos</title>
</head>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        font-family: Arial, sans-serif;
        background-color: #f3f0f0;
    }
    
    .header-container {
        display: flex;
        align-items: center;
        gap: 15px;
        background: linear-gradient(to right, #b7a696, #846c5b);
        color: #eeeeee;
        height: 6rem;
    }

    .header-container i {
        font-size: 32px;
        color: #eeeeee;
        background-color: #ad9c8b;
        padding: 0.5rem;
        border-radius: 5px;
        margin-left: 2rem;
    }

    .text-content {
        display: flex;
        flex-direction: column;
    }

    .text-content h1 {
        font-size: 1.5rem;
        color: #eeeeee;
    }

    .text-content p {
        color: #d5cfc8;
    }

    .infos {
        display: flex;
        justify-content: space-around;
        margin: 2rem 0;
    }    

    .infosBox{
        width: 30rem;
        height: 10rem;
        background-color: #ffffff;
        border-radius: 10px;
        border: 1px solid #B7A696;
    }

    .infosTitle {
        display: flex;
        flex-direction: row;
        justify-content: start;
        margin-left: 4rem;
        gap: 15rem;
    }

    .infosBox h3 {
        font-size: 1rem;
        color: #b7a696;
        margin-top: 2.2rem;
    }

    .iconInfos {
        width: 1.5rem;
        height: 1.5rem;
        color: 	#B7A696;
        margin-top: 2.2rem;
    }

    .result {
        margin-left: 4rem;
        margin-top: 0.8rem;
        color: #1d1d1d;
    }

    .infosDescricao {
        color: #B7A696;
        font-size: .9rem;
        margin-top: 0.5rem;
        margin-left: 4rem;
    }

    /* Estilo para tabela */
    .csv-table {
        border-collapse: collapse;
        width: 90%;
        margin: 2rem auto;
        background-color: #fff;
        border-radius: 8px;
        overflow: hidden;
    }
    .csv-table th, .csv-table td {
        border: 1px solid #333;
        padding: 8px 12px;
        text-align: center;
    }
    .csv-table th {
        background-color: #f2f2f2;
    }
    .csv-table tr:nth-child(even) {
        background-color: #fafafa;
    }

    /* Formulário centralizado */
    .form-upload {
        text-align: center;
        margin: 2rem 0;
    }
    .form-upload input, .form-upload button {
        padding: 10px 15px;
        font-size: 16px;
    }

    .upload-btn-wrapper {
    position: relative;
    overflow: hidden;
    display: inline-block;
    margin: 0 auto;

}

.upload-btn-wrapper2 {
    position: relative;
    overflow: hidden;
    display: inline-block;
    margin: 0;
    text-align: end;

}

        .upload-btn-wrapper .btn {
            border: none;
            color: #846c5b;
            background-color: #d3cac5;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        
        .upload-btn-wrapper input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-btn-wrapper2 .btn2 {
            border: none;
            color: #846c5b;
            background-color: #d3cac5;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            justify-content: start;
        }

        
        .upload-btn-wrapper2 input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }


        .upload-btn-wrapper:hover {
            cursor: pointer;
        }

        .upload-btn-wrapper2:hover {
            cursor: pointer;
        }

        .infoEnvioCSV {
            text-align: center;
            width: 100%;
            display: flex;
            justify-content: center;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 3rem;
        }

        .infoEnvioCSV p {
            max-width: 40rem;
            margin: 0 auto;
            line-height: 1.5;
            color: #846c5b;
            font-size: 1rem;
        }

        .upload-container {
            margin: 2rem auto;
            width: 40rem;
            background: #fff;
            border: 2px dashed #d3c4b8;
            border-radius: 12px;
            padding: 2rem;
            display: flex;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
        }

        .hidden {
            display: none;
        }

        #preview {
            margin-top: 2rem;
            padding: 1rem;
            border-radius: 10px;
        }

        .csvExemplo {
            width: 40rem;
            height: 8rem;
            background-color: rgb(238, 236, 236);
            margin: 0 auto;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            border: 2px solid #d5cfc8;
            text-align: center;
            gap: 1rem;
        }

        .csvExemplo p {
            color: #846c5b;
            margin-top: 1rem;
        }

         .btn {
            padding: 10px 20px;
            background: #ad9482;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 20rem;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 2rem;
            justify-content: center;
            cursor: pointer;
        }

        .btn:hover {
            cursor: pointer;
            background-color: red;
        }
        .uploadIcon {
            width: 3rem;
            margin: 0 auto;
        }

        .upload-container h2{
            font-weight: 100;
            font-size: 1.5rem;
            text-align: center;
        }

        .upload-container p{
            color: #846c5b;
            text-align: center;
            margin-bottom: 1rem;
        }

        .uploadIcon2 {
            width: 1.5rem;
        }

        .carregaNovoArquivo {
            display: flex;
            justify-content: center;
            gap: 70rem;
        }

        .escritasNovoArquivo {
            display: flex;
            flex-direction: column;
            margin-left: rem;
        }

        .escritasNovoArquivo p {
            color: #846c5b;
            margin-top: .5rem;
        }

        .distribuicao-produtos-wrapper {
            background-color: red;
        }
</style>
<body>
    <header class="header-container">
        <i class="fa-solid fa-chart-line"></i>
        <div class="text-content">
            <h1>Distribuição de Produtos</h1>
            <p>Ferramenta interna para análise de distribuição</p>
        </div>
    </header>
    
    <main>

        <section>
            <div class="infos">
                <div class="infosBox">
                    <div class="infosTitle">
                        <h3>Total de Produtos</h3>
                        <img src="{{ url_for('static', filename='imgs/box.png') }}" alt="boxIcon" class="iconInfos">
                    </div>
                    <h1 class="result">1984</h1>
                    <p class="infosDescricao">Produtos carregados</p>
                </div>

                <div class="infosBox">
                    <div class="infosTitle">
                        <h3>Lojas Ativas</h3>
                        <img src="{{ url_for('static', filename='imgs/file.png') }}" alt="fileIcon" class="iconInfos">
                    </div>
                    <h1 class="result">1</h1>
                    <p class="infosDescricao">Lojas com distribuição</p>
                </div>

                <div class="infosBox">
                    <div class="infosTitle">
                        <h3>Análises</h3>
                        <img src="{{ url_for('static', filename='imgs/dashboard.png') }}" alt="fileIcon" class="iconInfos">
                    </div>
                    <h1 class="result">1</h1>
                    <p class="infosDescricao">Relatórios processados</p>
                </div>
            </div>
        </section>

        <section>
            <div class="infoEnvioCSV" id="uploadArea2">
                <h2>Carregue seu arquivo de distribuição</h2>
                <p>Faça upload de um arquivo CSV ou Excel com os dados de distribuição de produtos para lojas e visualize as informações em 
                    uma tabela organizada e interativa.
                </p>
            </div>

            <div id="uploadArea" class="upload-container">
                <img src="{{ url_for('static', filename='imgs/upload.png') }}" alt="fileIcon" class="uploadIcon">
                <h2>Carregar arquivo de distribuição</h2>
                <p>Arraste e solte um arquivo CSV ou Excel aqui, ou clique para selecionar</p>
                <div class="upload-btn-wrapper">
                    <button class="btn">
                        <img src="{{ url_for('static', filename='imgs/upload2.png') }}" alt="fileIcon" class="uploadIcon2">
                        Selecionar Arquivo
                    </button>
                    <input type="file" id="fileInput" accept=".csv, .xlsx" />
                </div>
                <br><br>
            </div>

            <!-- Tabela do CSV -->
            <div id="preview">
                <div id="tabelaContainer">
                    {{ tabelaDistribuicao|safe }}
                </div>
            </div>

        </section>
    </main>
</body>
</html>

<script>
    const fileInput = document.getElementById("fileInput");

fileInput.addEventListener("change", () => {
    if (fileInput.files.length > 0) {
        enviarArquivo(fileInput.files[0]);
    }
});

document.addEventListener("dragover", e => e.preventDefault());
document.addEventListener("drop", e => {
    e.preventDefault();
    if (e.dataTransfer.files.length > 0) {
        enviarArquivo(e.dataTransfer.files[0]);
    }
});

const initialFileInput = document.getElementById('fileInput'); 
const uploadArea = document.getElementById('uploadArea');
const preview = document.getElementById('preview');

if (initialFileInput) {
  initialFileInput.addEventListener('change', () => {
    if (initialFileInput.files.length > 0) {
      enviarArquivo(initialFileInput.files[0]);
    }
  });
}

document.addEventListener('dragover', e => e.preventDefault());
document.addEventListener('drop', e => {
  e.preventDefault();
  if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
    enviarArquivo(e.dataTransfer.files[0]);
  }
});

async function enviarArquivo(file) {
  try {
    console.log("Enviando arquivo:", file.name);
    const formData = new FormData();
    formData.append("file", file);

    preview.innerHTML = '<p>Processando arquivo…</p>';
    preview.style.display = "block";

    const res = await fetch("/distribuicao/upload", {
      method: "POST",
      body: formData
    });

    if (!res.ok) {
      const text = await res.text();
      console.error("Erro no servidor:", res.status, text);
      preview.innerHTML = `<p>Erro ao processar arquivo: ${res.statusText}</p>`;
      return;
    }

    const html = await res.text();

    // Limpa preview
    preview.innerHTML = '';

    const container = document.createElement('div');
    container.className = 'carregaNovoArquivo';

    // Texto informativo
    const texts = document.createElement('div');
    texts.className = 'escritasNovoArquivo';
    texts.innerHTML = `<h1>Dados Carregados</h1><p>Arquivo processado com sucesso</p>`;
    container.appendChild(texts);

    // Wrapper do botão Alterar de arquivo (tem input)
    const wrapperAlterar = document.createElement('div');
    wrapperAlterar.className = 'upload-btn-wrapper2';

    const btnAlterar = document.createElement('button');
    btnAlterar.className = 'btn2';
    btnAlterar.type = 'button';
    btnAlterar.innerHTML = 'Alterar de arquivo';

    const newInput = document.createElement('input');
    newInput.type = 'file';
    newInput.accept = '.csv, .xlsx';

    wrapperAlterar.appendChild(btnAlterar);
    wrapperAlterar.appendChild(newInput);

    // Botão Processar arquivo (SEM input e SEM lógica JS)
    const btnProcessar = document.createElement('button');
    btnProcessar.className = 'btn2';
    btnProcessar.type = 'button';
    btnProcessar.innerHTML = 'Processar arquivo';

    const wrapperProcessar = document.createElement('div');
    wrapperProcessar.className = 'upload-btn-wrapper2';
    wrapperProcessar.appendChild(btnProcessar);

    // Coloca os dois lado a lado
    const wrapperGeral = document.createElement('div');
    wrapperGeral.style.display = 'flex';
    wrapperGeral.style.gap = '10px';
    wrapperGeral.appendChild(wrapperAlterar);
    wrapperGeral.appendChild(wrapperProcessar);

    container.appendChild(wrapperGeral);
    preview.appendChild(container);

    // Insere tabela do backend
preview.insertAdjacentHTML('beforeend', html);

// Seleciona a tabela que acabou de ser inserida
const tabela = preview.querySelector('table'); // assumindo que é a primeira tabela inserida

// ==================== NOVA SEÇÃO ====================
const produtosWrapper = document.createElement('div');
produtosWrapper.className = 'distribuicao-produtos-wrapper';

// Esquerda: título e quantidade
const leftDiv = document.createElement('div');
leftDiv.innerHTML = `<strong>Distribuição de Produtos</strong> <span>1984 itens</span>`;

// Centro: input de busca
const searchInput = document.createElement('input');
searchInput.type = 'text';
searchInput.placeholder = 'Buscar...';
searchInput.style.margin = '0 10px';

// Direita: botão exportar CSV
const exportBtn = document.createElement('button');
exportBtn.innerText = 'Exportar CSV';
exportBtn.className = 'btn2';
exportBtn.type = 'button';

// Junta tudo
produtosWrapper.appendChild(leftDiv);
produtosWrapper.appendChild(searchInput);
produtosWrapper.appendChild(exportBtn);

// **Insere a seção logo antes da tabela**
if (tabela) {
  tabela.insertAdjacentElement('beforebegin', produtosWrapper);
} else {
  // fallback caso a tabela não exista
  preview.appendChild(produtosWrapper);
}



    // Esconde áreas antigas de upload
    if (uploadArea) uploadArea.style.display = 'none';
    const uploadArea2 = document.getElementById('uploadArea2');
    if (uploadArea2) uploadArea2.style.display = 'none';

    // Eventos apenas do botão Alterar de arquivo
    btnAlterar.addEventListener('click', () => newInput.click());
    newInput.addEventListener('change', () => {
      if (newInput.files.length > 0) {
        enviarArquivo(newInput.files[0]);
      }
    });

    console.log("Tabela exibida com Alterar de arquivo + Processar arquivo (visual).");
  } catch (err) {
    console.error("Erro no upload:", err);
    preview.innerHTML = `<p>Erro ao enviar arquivo: ${err.message}</p>`;
  }
}

</script>